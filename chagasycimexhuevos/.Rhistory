dayone <- which(Compile$week==1)
#par(mfrow=c(1,1))
pdf("egg_total_hist.pdf")
hist(Compile$egg_total[dayone], breaks=max(Compile$egg_total[dayone]))
#dev.off()
#dev.off()
#create a factor id for mice for STATA
mice<-unique(Compile$mouse)
mouseidnum<-c(1:length(mice))
mousetable<-data.frame(mice,mouseidnum)
mousetable$mouseidnum<-as.factor(mousetable$mouseidnum)
Compile$mouseidnum<-Compile$trial*0
for(i in 1:length(mice)){
micenumi<-which(mousetable$mouseidnum==i)
micematch<-which(Compile$mouse==mousetable$mice[micenumi])
Compile$mouseidnum[micematch]<-i
}
##create total values for each insect
#create rows to fill by loop
#make two rows to fill
Compile$lifespan<-Compile$eggs*NA
Compile$avtemp_total<-Compile$eggs*NA
Compile$avlowtemp_total<-Compile$eggs*NA
Compile$avhightemp_total<-Compile$eggs*NA
Compile$avhum_total<-Compile$eggs*NA
Compile$avlowhum_total<-Compile$eggs*NA
Compile$avhighhum_total<-Compile$eggs*NA
Compile$hightemp_total<-Compile$eggs*NA
Compile$highhum_total<-Compile$eggs*NA
Compile$lowtemp_total<-Compile$eggs*NA
Compile$lowhum_total<-Compile$eggs*NA
#identify living observations so temperatures while the
#insect is dead does not have affect
lives <- which(Compile$alive==1)
#loop over each insect and calculate average and max/min/diff
#add dfference
for (i in 1:max(Compile$idnum)) {
ids<-which(Compile$idnum==i)
is <- intersect(ids, lives)#that way you don't add dead times to observations
#average temperatures
avgt<-mean(Compile$avtemp[is], na.rm=TRUE)
avght<-mean(Compile$avtemphigh[is], na.rm=TRUE)
avglt<-mean(Compile$avtemplow[is], na.rm=TRUE)
#average humidity
avgh<-mean(Compile$avhum[is], na.rm=TRUE)
avghh<-mean(Compile$avhumhigh[is], na.rm=TRUE)
avglh<-mean(Compile$avhumlow[is], na.rm=TRUE)
#Max and min Temp
maxt <- max(Compile$tempmax[is], na.rm=TRUE)
mint <- min(Compile$tempmin[is], na.rm=TRUE)
#Max and min hum
maxh <- max(Compile$hummax[is], na.rm=TRUE)
minh <- min(Compile$tempmin[is], na.rm=TRUE)
#Longevity (The weeks alive)
ls<-length(is)
#Put the calculated items into the appropriate vectors of data frame
Compile$lifespan[ids]<-ls
Compile$avtemp_total[ids]<-avgt
Compile$avlowtemp_total[ids]<-avglt
Compile$avhightemp_total[ids]<-avght
Compile$avhum_total[ids]<-avgh
Compile$avlowhum_total[ids]<-avglh
Compile$avhighhum_total[ids]<-avghh
Compile$hightemp_total[ids]<-maxt
Compile$highhum_total[ids]<-maxh
Compile$lowtemp_total[ids]<-mint
Compile$lowhum_total[ids]<-minh
}
#write.csv(Compile,"CompiledFertilityData.csv")
###############################################################################
#==============================================================================
#ahora tenomos muchas graficas, podemos empezar haciendo el modelo
#########################################################
#reduce the data to just the first week
weekone<-which(Compile$week==1)
single<-Compile[weekone,]
##Now go through each temperature and humidity covariate by graphing
#see which variables will be used for temperature and humidity
pdf("Hum_Temp_covariates.pdf")
par(mfrow=(c(2,5)))
#eggs by average humidity
segghum<-ggplot(aes( y= eggs, x= avhum_total, na.rm=TRUE),
data=single)+geom_point(data=single)
segghum<-segghum+ggtitle("Number of Eggs Laid by Average Humidity and Infection Status")
segghum<-segghum+facet_grid(. ~infected)+geom_smooth(method= "lm")
segghum
seghum<-glm(eggs ~infected*avhum_total, data=single)
seghum
#egg avg high humidity
segghighhum <- ggplot(aes( y= eggs, x= avhighhum_total, na.rm=TRUE),
data=single)+geom_point(data=single)
segghighhum <- segghighhum+ggtitle("Number of Eggs Laid by Average High Humidity and Infection Status")
segghighhum <- segghighhum+facet_grid(. ~infected)+geom_smooth(method= "lm")
segghighhum
seghighhum <- glm(eggs ~infected*avhighhum_total, data=single)
seghighhum
#egg avg low humidity
segglowhum <- ggplot(aes( y= eggs, x= avlowhum_total, na.rm=TRUE),
data=single)+geom_point(data=single)
segglowhum <- segglowhum+ggtitle("Number of Eggs Laid by Average Low Humidity and Infection Status")
segglowhum <- segglowhum+facet_grid(. ~infected)+geom_smooth(method= "lm")
segglowhum
seglowhum <- glm(eggs ~infected*avlowhum_total, data=single)
seglowhum
#egg max humidity
seggmaxhum <- ggplot(aes( y= eggs, x= highhum_total, na.rm=TRUE),
data=single)+geom_point(data=single)
seggmaxhum <- seggmaxhum+ggtitle("Number of Eggs Laid by Maximum Humidity and Infection Status")
seggmaxhum <- seggmaxhum+facet_grid(. ~infected)+geom_smooth(method= "lm")
seggmaxhum
segmaxhum <- glm(eggs ~infected*highhum_total, data=single)
segmaxhum
#egg min humidity
segglowhum <- ggplot(aes( y= eggs, x= lowhum_total, na.rm=TRUE),
data=single)+geom_point(data=single)
segglowhum <- segglowhum+ggtitle("Number of Eggs Laid by Minimum Humidity and Infection Status")
segglowhum <- segglowhum+facet_grid(. ~infected)+geom_smooth(method= "lm")
segglowhum
seglowhum <- glm(eggs ~infected*lowhum_total, data=single)
seglowhum
##Temperature
#eggs by average temperature
seggtemp<-ggplot(aes( y= eggs, x= avtemp_total, na.rm=TRUE),
data=single)+geom_point(data=single)
seggtemp<-seggtemp+ggtitle("Number of Eggs Laid by Average Temperature and Infection Status")
seggtemp<-seggtemp+facet_grid(. ~infected)+geom_smooth(method= "lm")
seggtemp
segtemp<-glm(eggs ~infected*avtemp_total, data=single)
segtemp
#egg avg high temperature
segghightemp<-ggplot(aes( y= eggs, x= avhightemp_total, na.rm=TRUE),
data=single)+geom_point(data=single)
segghightemp<-segghightemp+ggtitle("Number of Eggs Laid by Average High Temperature and Infection Status")
segghightemp<-segghightemp+facet_grid(. ~infected)+geom_smooth(method= "lm")
segghightemp
seghightemp<-glm(eggs ~infected*avhightemp_total, data=single)
seghightemp
#egg avg low termperatuer
segglowtemp<-ggplot(aes( y= eggs, x= avlowtemp_total, na.rm=TRUE),
data=single)+geom_point(data=single)
segglowtemp<-segglowtemp+ggtitle("Number of Eggs Laid by Average Low Temperature and Infection Status")
segglowtemp<-segglowtemp+facet_grid(. ~infected)+geom_smooth(method= "lm")
segglowtemp
seglowtemp<-glm(eggs ~infected*avlowtemp_total, data=single)
seglowtemp
#egg max temperature
seggmaxtemp<-ggplot(aes( y= eggs, x= hightemp_total, na.rm=TRUE),
data=single)+geom_point(data=single)
seggmaxtemp<-seggmaxtemp+ggtitle("Number of Eggs Laid by Maximum Temperature and Infection Status")
seggmaxtemp<-seggmaxtemp+facet_grid(. ~infected)+geom_smooth(method= "lm")
seggmaxtemp
segmaxtemp<-glm(eggs ~infected*hightemp_total, data=single)
segmaxtemp
#egg min temperature
seggmintemp<-ggplot(aes( y= eggs, x= lowtemp_total, na.rm=TRUE),
data=single)+geom_point(data=single)
seggmintemp<-seggmintemp+ggtitle("Number of Eggs Laid by Minimum Temperature and Infection Status")
seggmintemp<-seggmintemp+facet_grid(. ~infected)+geom_smooth(method= "lm")
seggmintemp
segmintemp<-glm(eggs ~infected*lowtemp_total, data=single)
segmintemp
par(mfrow=c(1,1))
dev.off()
#el ejemplo de Ricardo
#glm(cases~rhs(data$year,2003)+lhs(data$year,2003)+ offset(log(population)), data=data, subset=28:36, family=poisson())
#fake code template
#Bring in Compiled data exported from code above.
Compile<-read.csv("CompiledFertilityData.csv")
#for box plots week was categorical.  This makes a numeric column.
Compile$weeknum<-as.numeric(Compile$week)
#I am also going to make a table with all egg and hatch are no longer NA but 0
Compile$hatchdiff<-Compile$eggs-Compile$hatch
Compile$infectedf<-as.factor(Compile$infected)
Compile$hatchdiff<-as.numeric(Compile$hatchdiff)
hatchbox<-ggplot(aes( x= hatchdiff, fill = infectedf, na.rm=TRUE),
data= Compile[enona,]) +geom_density(alpha=0.5, na.rm=TRUE)#geom_histogram(aes(y="..density.."),position="dodge")
hatchbox<-hatchbox+ggtitle("Relative denisty of differences between hatched and laid eggs by infection status")
hatchbox<-hatchbox+scale_fill_manual(values=c("blue", "red"))
ggsave(g, file="HatchDiffDensity.jpeg", units= "cm", width = 26.4, height= 15.875)
#g<-g+scale_x_continuous(breaks=seq(0, 38, 2))
#g<-g+scale_x_discrete(labels=c("", seq())
hatchbox
#Eggsave(hatchbox, file="HatchDiffDensityByInf.jpeg", units= "cm", width = 26.4, height= 15.875)
CompileNoNA<-Compile
eggna <- which(is.na(CompileNoNA$eggs)==TRUE)
hatchna <- which(is.na(CompileNoNA$hatch)==TRUE)
CompileNoNA$eggs[eggna]<-0
CompileNoNA$hatch[hatchna]<-0
#Make Compile where NA's eggs are removed.
CompileRD<-Compile[-eggna,]
#One final change to the data frames, I would like to make a julian day vector.
#provides numeric value for possible seasonaility analysis from the initial observation.
#careful this is not necessesary
dateRD<-julian.Date(CompileRD$date)
startDate<-julian.Date(CompileRD$start)
mindate<-min(startDate)
CompileRD$juliandate<-dateRD-startDate
#we found that we need to conduct a cox proportional hazaard test for time until first egg
#thus we need to first reverse the binary of egg event.
Compile$reveggevent<-1-Compile$eggevent
#http://socserv.socsci.mcmaster.ca/jfox/Books/Companion/appendix/Appendix-Cox-Regression.pdf
sevent<-Surv(time=CompileRD$weeknum, event=CompileRD$eggevent)
#need to get rid of the "+"
CoxEggLaid<-coxph(sevent~infected+cluster(idnum), data=CompileRD)
#summary(survfit(CoxEggLaid, newdata =))
#because events occur more than once its a mess because "+" are added.
hist(CoxEggLaid)
#The models remove the NA's so lets use CompileRD to make two simple graphs
hist(CompileRD$eggs, breaks=21)
mean(CompileRD$eggs)#3.94
var(CompileRD$eggs) #17.5
#This shows that poisson assumptions are not met.
#earlier(under the poisson models) I took the variance of a mean by week...which gave me a smaller value of course.
#But yes, poisson values are not the same.
#lets combine the data to remove 0 inflation
#Use the Collapse to break into smaller groups
#function that takes in the desired number of weeks per periood
SummaryCompileRD<-function(segl){
#Create an emty output vector
CompileRD$period<-CompileRD$week*0
#Calculate the appropriate variables: total number of weeks and the number of segments
maxw<-max(Compile$week)
nseg<-maxw/segl
nseg<-ceiling(nseg)
#assign each week into one of the segments. This starts with all the sets and
#adds 1 to the period vector
#then it removes the first segment( or period) and adds another 1 to the remaining segments until
#each week has the corresponding period designation.
for(i in 1:nseg){
adding<-which(CompileRD$week>((segl*i)-segl))
CompileRD$period[adding]<-CompileRD$period[adding]+1
}
#   #this is a test
#   CompileRD$periods<-CompileRD$week*0
#   addingq<-which(CompileRD$week>(0))
#   CompileRD$periods[addingq]<-CompileRD$periods[addingq]+1
#   d<-c(rep(1:3, each=10))
#   tree<-which(d>1)
#   d[tree]<-d[tree]+1
#   d
#create unicode to merge tables later.
CompileRD$periodid<-paste(CompileRD$idnum, CompileRD$period, sep="-")
#redefine functions so na.rm is fed into the function
#be aware that this can introduce 0's, but it is on CompileRD so that
#should only happen for hatch when egg is already 0.
sums<-function(row){
sum(row, na.rm=TRUE)
}
maxs<-function(row){
max(row, na.rm=TRUE)
}
mins<-function(row){
min(row, na.rm=TRUE)
}
means<-function(row){
mean(row, na.rm=TRUE)
}
#These functions perform a function on the desired outputs as it reduces the
#data from weeks to the desired period.
CompileRDsum<-summaryBy(eggs+hatch+alive~idnum+period+infected+
mouse+trial+periodid, FUN=c(sums),
data=CompileRD, keep.names = TRUE)
CompileRDmax<-summaryBy(tempmax+tempdiff+hummax+humdiff~periodid,
FUN=c(maxs), data=CompileRD, keep.names = TRUE)
CompileRDmin<-summaryBy(tempmin+hummin~periodid, FUN=c(mins), data=CompileRD,
keep.names = TRUE)
CompileRDmean<-summaryBy(avtemphigh+avtemplow+avtemp+avhumhigh+avhumlow+avhum
~periodid, FUN=c(means), data=CompileRD, keep.names = TRUE)
a<-merge(CompileRDmax, CompileRDmean, by="periodid")
b<-merge(a, CompileRDmin, by="periodid")
final<-merge(b, CompileRDsum, by="periodid")
final
}
#lets look at 2 and 3
C2week<-SummaryCompileRD(2)
C3week<-SummaryCompileRD(3)
C5week<-SummaryCompileRD(5)
C8week<-SummaryCompileRD(8)
#
fivedead<-which(C5week$alive<5)
#checking code
zeroeight<-which(C8week$eggs==0)
zerotable<-C8week[zeroeight,]
zeroids<-unique(zerotable$idnum)
removedeathday<-function(weektab){
deads<-which(weektab$alive<max(weektab$alive))
tablerd<-weektab[,-deads]
tablerd
}
C2weekRd<-removedeathday(C2week)
#10-2 is one with 0's
tens<-which(Compile$idnum==10)
tentable<-Compile[tens,]
#plot the 0's
plot(1:37,1:37,col=0)
for (i in 1:20){
zer<-which(Compile$idnum==zeroids[i])
lines(Compile$week[zer], Compile$eggs[zer], col=i)
}
plot(1:37,1:37,col=0)
for (i in 21:40){
zer<-which(Compile$idnum==zeroids[i])
lines(Compile$week[zer], Compile$eggs[zer], col=i)
}
plot(1:37,1:37,col=0)
for (i in 41:60){
zer<-which(Compile$idnum==zeroids[i])
lines(Compile$week[zer], Compile$eggs[zer], col=i)
}
plot(1:37,1:37,col=0)
for (i in 61:80){
zer<-which(Compile$idnum==zeroids[i])
lines(Compile$week[zer], Compile$eggs[zer], col=i)
}
# pdf("compacted_egg_hist.pdf")
# par(mfrow=c(3,1))
# hist(CompileRD$eggs, breaks=compmax)
# hist(C2weeklive$eggs, breaks=twomax)
# hist(C3weeklive$eggs, breaks=threemax)
# dev.off()
#write.csv(CompileRD,"ReducedCompiledFertility Data.csv")
#write.csv( C2weeklive, "2weekGroupedFertilityData_simple.csv")
#write.csv(C3weeklive, "3weekGroupedFertilityData_simple.csv")
plot(CompileRD$week, CompileRD$eggs)
plot(log(CompileRD$week+1+rnorm(length(CompileRD$eggs), 0, 0.5)), CompileRD$eggs+rnorm(length(CompileRD$eggs), 0, 0.5))
#for box plots week was categorical.  This makes a numeric column.
Compile$weeknum<-as.numeric(Compile$week)
gmod1<-geem(eggs ~infected, id=idnum, data=Compile, family=poisson, corstr="exchangeable", Mv=1)
pmod1a<-glm(eggs ~ +(1|idnum), offset=log(visits+1), data = Compile, family ="poisson")
pmod1b<-glm(eggs ~ infected, data = Compile, family = poisson) #17383
pmod1c<-glm(eggs ~ weeknum, data = Compile, family = poisson) #17187
pmod1d<-glm(eggs ~ mouse, data = Compile, family = poisson) #17113
pmod1e<-glm(eggs ~ trial, data = Compile, family = poisson) #17695
pmod1f<-glm(eggs ~ avtemphigh, data = Compile, family = poisson) #17695
pmod1g<-glm(eggs ~ avtemplow, data = Compile, family = poisson) #17322
pmod1h<-glm(eggs ~ avtemp, data = Compile, family = poisson) #17417
pmod1i<-glm(eggs ~ tempmax, data = Compile, family = poisson) #17356
pmod1j<-glm(eggs ~ tempmin, data = Compile, family = poisson) #17284
pmod1k<-glm(eggs ~ tempdiff, data = Compile, family = poisson) #17413
pmod1l<-glm(eggs ~ avhumhigh, data = Compile, family = poisson) #17419
pmod1m<-glm(eggs ~ avhumlow, data = Compile, family = poisson) #17440
pmod1n<-glm(eggs ~ avhum, data = Compile, family = poisson) #17450
pmod1o<-glm(eggs ~ hummax, data = Compile, family = poisson) #17442
pmod1p<-glm(eggs ~ hummin, data = Compile, family = poisson) #17482
pmod1q<-glm(eggs ~ humdiff, data = Compile, family = poisson) #17452
pmod2a2 <- glm(eggs ~ week + (1|idnum), data = Compile, family = poisson) #17383
pmod2a <- glm(eggs ~ infected + (1|idnum), data = Compile, family = poisson) #17383
pmod2al <- glm(eggs ~ infected+weeknum, data = Compile, family = poisson)
pmod2am <- glm(eggs ~ mouse + (1|idnum), data = Compile, family = poisson) #17113
pmod2both <- glm(eggs ~ mouse + infected+ (1|idnum), data = Compile, family = poisson) #17113
pmod2b <- glm(eggs ~ infected+weeknum + (1|idnum), data = Compile, family = poisson) #16713
pmod2c <- glm(eggs ~ infected+weeknum+ avtemp + (1|idnum), data = Compile, family = poisson)#16545
pmod2d<- glm(eggs ~ infected+weeknum+ avtemp + avhum+ (1|idnum), data = Compile, family = poisson)#1647416
pmod2e<- glm(eggs ~ infected+weeknum+ avtemp + avhum+alive+ (1|idnum), data = Compile, family = poisson)#
#mod2f<- glm(eggs ~ infected+weeknum+ avtemp + avhum+alive+ (1|idnum), data = Compile, family = neg.bin())
pmod2fboth<- glm(eggs ~ infected+mouse+weeknum+ avtemp + avhum+alive+ (1|idnum), data = Compile, family =poisson)#16075
#plotting models onto the original data. use model$fitted on the NA removed dataframe
plot(CompileRD$week, CompileRD$eggs)
lines(CompileRD$week, pmod2a2$fitted)
#check assumptions for poisson.  This uses values from above so disregard.
#aveggweek<-mean(totegg$xbar, na.rm=T)  #2.61
#var(totegg$xbar, na.rm=T)   #3.48
#upperlimmean<-aveggweek+(1.96*(sd(totegg$xbar, na.rm=T)/sqrt(length(totegg$xbar)))) #3.21
#lowlimvar<-(length(totegg$xbar)-1)*(var(totegg$xbar, na.rm=T))/41.923 #2.98
#does not survive hypothesis test that they are
#using MASS package, use the glm.nb for a negative binomial model
#run model and look at AICs, below there is a formula to interpret. But basically if AIC is >3
#############Negative Binomial###################
#at the end of the day we want to know if infection is responsible for change eggs
#when other envir. factors excluded and the change in lifespan.
#how I understand, not having interaction will only change intercept, not slope
nbmod1a<-glm.nb(eggs ~ weeknum+ (1|idnum), data=Compile) #AIC= 11999 (much better than any poisson)
nbmod1b<-glm.nb(eggs ~ infected+weeknum+ (1|idnum), data=Compile) #AIC 11917
nbmod1c<-glm.nb(eggs ~ infected*weeknum+ (1|idnum), data=Compile) #AIC 11911 (AIC of >=6 is sign.)
#now we have a base model, lets look at how humidity and temperature affect
nbmod2a<-glm.nb(eggs ~ infected*weeknum+avhum+ (1|idnum), data=Compile) #AIC=11858
nbmod2b<-glm.nb(eggs ~ infected*weeknum+avhum+avhum*infected+(1|idnum), data=Compile)# 11816
nbmod2c<-glm.nb(eggs ~ infected*weeknum+avhumhigh+(1|idnum), data=Compile)#11858
nbmod2d<-glm.nb(eggs ~ infected*weeknum+avhumhigh+avhumhigh*infected+(1|idnum), data=Compile)#11821
nbmod2e<-glm.nb(eggs ~ infected*weeknum+avhumlow+ (1|idnum), data=Compile)#11851
nbmod2f<-glm.nb(eggs ~ infected*weeknum+avhumlow+avhumlow*infected+(1|idnum), data=Compile)#11813
nbmod2g<-glm.nb(eggs ~ infected*weeknum+avtemp+(1|idnum), data=Compile)#11850
nbmod2h<-glm.nb(eggs ~ infected*weeknum+avtemp+avtemp*infected+(1|idnum), data=Compile)# 11846
nbmod2i<-glm.nb(eggs ~ infected*weeknum+avtemphigh+(1|idnum), data=Compile)# 11853
nbmod2j<-glm.nb(eggs ~ infected*weeknum+avtemphigh+avtemphigh*infected+(1|idnum), data=Compile)#11848
nbmod2k<-glm.nb(eggs ~ infected*weeknum+avtemplow+(1|idnum), data=Compile)#11850
nbmod2l<-glm.nb(eggs ~ infected*weeknum+avtemplow+avtemplow*infected+(1|idnum), data=Compile)#11848
nbmod2m<-glm.nb(eggs ~ infected*weeknum+hummax+(1|idnum), data=Compile)#11857
nbmod2n<-glm.nb(eggs ~ infected*weeknum+hummax+hummax*infected+(1|idnum), data=Compile)#11830
nbmod2o<-glm.nb(eggs ~ infected*weeknum+hummin+ (1|idnum), data=Compile) #11858
nbmod2p<-glm.nb(eggs ~ infected*weeknum+hummin+hummin*infected+(1|idnum), data=Compile) #11810
nbmod2q<-glm.nb(eggs ~ infected*weeknum+humdiff+(1|idnum), data=Compile)# 11859
nbmod2r<-glm.nb(eggs ~ infected*weeknum+humdiff+humdiff*infected+(1|idnum), data=Compile)#11860
nbmod2s<-glm.nb(eggs ~ infected*weeknum+tempmax+ (1|idnum), data=Compile)#11853
nbmod2t<-glm.nb(eggs ~ infected*weeknum+tempmax+tempmax*infected+(1|idnum), data=Compile)#11854
nbmod2u<-glm.nb(eggs ~ infected*weeknum+tempmin+(1|idnum), data=Compile)#11847
nbmod2v<-glm.nb(eggs ~ infected*weeknum+avhum+tempmin*infected+(1|idnum), data=Compile)#11841
nbmod2w<-glm.nb(eggs ~ infected*weeknum+avhum+(1|idnum), data=Compile)#11858
nbmod2z<-glm.nb(eggs ~ infected*weeknum+avhum+avhum*infected+(1|idnum), data=Compile)#11816
#Now we have strongest hum temp.  Lets add the missing pieces.
###OLD stuf
nbmod1<-glm.nb(eggs ~ infected+weeknum+avhum+ (1|idnum), data=Compile) #AIC 11867
nbmod2<-glm.nb(eggs ~ infected+weeknum+avtemp+ (1|idnum), data=Compile) #AIC 11858
nbmod3<-glm.nb(eggs ~ infected+weeknum+avhum+avtemp + (1|idnum), data=Compile) #AIC 11852
nbmod3a<-glm.nb(eggs ~ infected+weeknum+avhum*avtemp + (1|idnum) , data=Compile) #AIC 11852
nbmod4<-glm.nb(eggs ~ infected+weeknum+avhum+avtemphigh+(1|idnum), data=Compile)#11855
nbmod5<-glm.nb(eggs ~ infected+weeknum+avhum+mouse+ (1|idnum), data=Compile) #11824
nbmod6<-glm.nb(eggs ~ infected+weeknum+avhum+mouse+infected*mouse+ (1|idnum), data=Compile) #11824
#6 was the same as 5 because there interactions are themselves linearly related adding no new information.
nbmod7<-glm.nb(eggs ~ infected+weeknum+avhum+mouse+alive+ (1|idnum), data=Compile)#11824
nbmod8<-glm.nb(eggs ~ infected+weeknum+avhum+mouse+avtemp+(1|idnum), data=Compile) #11789
#now letsa add the difference.
nbmod9<-glm.nb(eggs ~ infected+weeknum+avhum+mouse+avtemp+humdiff+(1|idnum), data=Compile) #11791
nbmod10<-glm.nb(eggs ~ infected+weeknum+avhum+mouse+avtemp+tempdiff+(1|idnum), data=Compile) #11791
#adding temp/hum diff does not add significantly to the model
nbmod11<-glm.nb(eggs ~ infected+weeknum+avhum+mouse+avtemp+hummax+(1|idnum), data=Compile) #11791
nbmod12<-glm.nb(eggs ~ infected+weeknum+avhum+mouse+avtemp+tempmax+(1|idnum), data=Compile) #11791
#as seen in graphs above an infected insect may be affected differently by temp/hum affects.
#thus lets add an interaction term.
nbmod13<-glm.nb(eggs ~ infected+weeknum+avhum+mouse+avtemp+tempmax+infected*avhum+(1|idnum), data=Compile)#11741
nbmod14<-glm.nb(eggs ~ infected+weeknum+avhum+mouse+avtemp+tempmax+infected*avtemp+(1|idnum), data=Compile)#11777
nbmod15<-glm.nb(eggs ~ infected+weeknum+avhum+mouse+avtemp+tempmax+infected*avhum+infected*avtemp+(1|idnum), data=Compile)#11750
#hence an interaction with humidity plays a bigger role than temperature or both interactions.
nbmod16<-glm.nb(eggs ~ infected+weeknum+avhum+avtemp+infected*avhum+(1|idnum), data=Compile)
#lets look at humidity variations keeping all else constant.  ()
#lets see if they are some better predictor for hum other than avhum
nbmod13<-glm.nb(eggs ~ infected+weeknum+mouse+hummax+avtemp+(1|idnum), data=Compile)#11794
#lets look at the plot for the negative binomial version of the simplest model.
plot(CompileRD$week, CompileRD$eggs)
lines(CompileRD$week, nbmod0$fitted)
mean(nbmod0$fitted)
mean(CompileRD$eggs)
#Plotting Residuals and predicted values.
par(mfrow=c(2,4))
#pdf(file="Poisson vs Negative Binomial Model of eggs by infected+weeknum+ (1 idnum).pdf")
plot(nbmod0, ylim=4)
title(main="Negative Binomial")
plot(mod2b)
title(main="Poisson")
#dev.off()
#http://www.ats.ucla.edu/stat/r/dae/zinbreg.htm Describes a 0 inflated negative binomial
zinbmod1 <- zeroinfl(eggs ~ weeknum + infected | persons,
data = zinb, dist = "negbin", EM = TRUE)
summary(m1)
#alive is not helpful because NA's are already removed.
#lets plot to get a sense of where we're at
par(mfrow=c(1,1))
plot(nbmod13)
testplot<-testplot+ggtitle("Number of Eggs Laid by Week and Infection Status")
testplot<-testplot+facet_grid(. ~infected)+geom_smooth(method= "lm")
testplot
plot(residuals(nbmod13))
#####MODEL FOR HATCH
#exp((AICmin-AICi)/2)=Probablity that i minimalizes information loss just as well as min.
#ln(prob)=AICmin-AICi/2
#2e^prob=difference between AICs.
#if sign prob is 0.05 then
2*(log(0.05))
# thus a difference in AIC of 6 o greater is a significant similar probablity for now.
test1<-exp((11824-11852)/2)
plot(Compile$weeknum, Compile$eggs)
lrtest(nbmod1, nbmod2)
lrtest(nbmod2,nbmod3)
#attemp ggem
geem1<-geem(eggs ~ infected+weeknum, id=idnum, data=Compile)
geem2<-geem(eggs ~ infected+weeknum, id=idnum, data=Compile, family=negative.binomial(0.7279))
geem2<-geem(eggs ~ infected+weeknum, id=idnum, data=Compile, family=poisson)
geem3<-geem(eggs ~ infected+weeknum, id=idnum, data=Compile, corstr="ar1")
geem4<-geem(eggs ~ infected+weeknum, id=idnum, data=Compile, family=negative.binomial(0.7279),corstr="ar1")
geem5<-geem(eggs ~ infected+weeknum, id=idnum, data=Compile, family=negative.binomial(0.7279),corstr="ar2")
geem6<-geem(eggs ~ infected+weeknum, id=idnum, data=Compile, family=negative.binomial(0.7279),corstr="ar3")
#starting with most complex model
CompileRD$mouseidnum<-as.factor(CompileRD$mouseidnum)
geem7<-geem(eggs ~infected+weeknum+trial+mouseidnum+avhumhigh+avtemphigh, id=idnum, data=CompileRD, family=negative.binomial(0.7279), corstr="exchangeable")
geem8<-geem(eggs ~infected+weeknum+trial+avhumhigh+avtemphigh, id=idnum, data=CompileRD, family=negative.binomial(0.7279), corstr="exchangeable")
geem9<-geem(eggs ~infected+weeknum+avhumhigh+avtemphigh, id=idnum, data=CompileRD, family=negative.binomial(0.7279), corstr="exchangeable")
geem10<-geem(eggs ~infected+weeknum+avtemphigh, id=idnum, data=CompileRD, family=negative.binomial(0.7279), corstr="exchangeable")
geem11<-geem(eggs ~infected+weeknum, id=idnum, data=CompileRD, family=negative.binomial(0.7279), corstr="exchangeable")
geem12<-geem(eggs ~infected+weeknum+avtemphigh+avtemphigh*infected, id=idnum, data=CompileRD, family=negative.binomial(0.7279), corstr="exchangeable")
geemp10<-geem(eggs ~infected+weeknum+avtemphigh, id=idnum, data=CompileRD, negative.binomial(theta=2, link="log"), corstr="exchangeable")
geemp12<-geem(eggs ~infected+weeknum+avtemphigh+avtemphigh*infected, id=idnum, data=CompileRD, family=poisson, corstr="exchangeable")
geemnb<-geem(eggs ~ infected+weeknum, id=idnum, data=Compile, family=negative.binomial(1))
geemnb1<-geem(eggs ~ infected+weeknum, id=idnum, data=Compile, family=negative.binomial(1))
geemp<-geem(eggs ~ infected+weeknum, id=idnum, data=Compile, family=poisson)
# QIC in R custom http://www.r-bloggers.com/r-script-to-calculate-qic-for-generalized-estimating-equation-gee-model-selection/
# Zero Inflated Negative Binomial
#maybe try "nlme" package
#--------------
#--------------------------------------------------------------------------
# Code to extract coeff., 95CIs, and define final estimates with p-values
#--------------------------------------------------------------------------
# # use following commands for confident intervals and coefficients:
# confint()
# exp(coef())
# exp(confint())
# Disabling scientific notation
## Enable at the end with options(scipen = 0)!!!
#
# options(scipen = 999)
# library(lme4)
#
# # Defining function to get the final estimates:
# # IRR, 95%CI, and p-value
#
# estimates<-function(x, print = TRUE){
#   ul<-coef(summary(x))[,1] + qnorm(0.975)*coef(summary(x))[,2]
#   ll<-coef(summary(x))[,1] + qnorm(0.025)*coef(summary(x))[,2]
#   logIRR.x<-cbind(coef(summary(x))[,1], ll, ul)
#   result<-IRR.x<-cbind(exp(logIRR.x), coef(summary(x))[,4])
#   return(result)
# }
Compile$lowhum_total
